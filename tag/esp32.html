<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>My Bug Has A Program! - esp32</title>
        <link rel="stylesheet" href="../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">My Bug Has A Program! </a></h1>
                <nav><ul>
                    <li><a href="../category/articles.html">articles</a></li>
                    <li><a href="../category/english.html">English</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../bee3-en.html">hachidori - APM on PC with remote sensor/actuators</a></h1>
<footer class="post-info">
        <abbr class="published" title="2017-12-01T00:00:00+09:00">
                Published: 金 01 12月 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/kaz-kojima.html">Kaz Kojima</a>
        </address>
<p>In <a href="../category/english.html">English</a>.</p>
<p>tags: <a href="../tag/ardupilot.html">ardupilot</a> <a href="../tag/esp32.html">esp32</a> </p>
</footer><!-- /.post-info --><p><meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@1gkojima" />
<meta property="og:url" content="https://kazkojima.github.io/bee3-en.html" />
<meta property="og:title" content="hachidori - APM on PC with remote sensor/actuators" />
<meta property="og:description" content="Hachidori which means 'humming bird' is a remote sensor/actuator board controlled by ArduPilot running on PC." />
<meta property="og:image" content="https://kazkojima.github.io/images/bee3-flight.jpg" /></p>
<p><img src="../images/bee3-flight2.jpg" alt="hachidori" width="640"></p>
<p>Hachidori which means 'humming bird' is a remote sensor/actuator board controlled by ArduPilot running on PC.  It's intended to contribute to ArduPilot, though it's still in the experimental phase. It's a tiny open project of <a href="https://github.com/DCoJA">DCoJA</a> started by DroneWorks Inc. I was a contractor with DroneWorks mainly for porting APM to their FC with the mezzanine board of 96boards. Hachidori was a project derived from that work. Although my contract with them ended already, I'm continuing to work with this tiny project individually. The related programs and schematics of hachidori are available as the open sources <a href="https://github.com/DCoJA">here</a>.</p>
<p><img src="../images/hachidori-01.png" alt="scheme" width="640"></p>
<p>From hachidori point of view, ArduPilot looks like a UDP server which receives sensor data and sends PWM values back.  It's a classical idea, but, yes, there are many issues with this scheme.  Anyways, here is a flight test of hachidori with a toy drone frame:</p>
<p><a href="https://drive.google.com/open?id=17t-W2Hi5uMc7od1iT-kai-gEbZudtBSQ"><img alt="test flight" src="../images/test-flight-toy.png" /></a></p>
<p>This is a flight in stabilize mode. APM runs on a laptop PC with Ubuntu 4.4.0-lowlatency kernel. Looks APM can control the attitude well.</p>
<p>Another hachidori with a 250 frame and its host PC on which APM runs:</p>
<p><img src="../images/hachidori-250-liftup.jpg" alt="250frame" width=320>
<img src="../images/hachidori-core-and-pc.jpg" alt="250 and PC" width=320></p>
<p>ArduPilot with the experimental hachidori drivers and the other information for hardware/software were maintained at <a href="https://github.com/DCoJA">DCoJA's github</a>.  See the hachidori branch of ardupilot there if you are interested.</p>
<p>The firmware of the remote side runs on ESP32 and uses <a href="https://github.com/espressif/esp-idf">esp-idf</a> and can be seen as an <a href="https://github.com/DCoJA/esp32-app/hachidori">application on esp-idf</a>.
Other tools like small servers for tests and configurations can be found at
<a href="https://github.com/DCoJA/junkyard">junkyard directory of DCoJA</a> as b3test and b3conf.</p>
<h2>latency</h2>
<p>One big problem of this scheme is latency.  As you know, almost usual RF protocols including Wi-Fi don't take care of latency so much.  Except Wi-Fi, they are always low power centric and Wi-Fi is throughput centric.  It looks that one of the major cause of the latency is re-sending which is not so worth for the real-time sensor data of the physical values.</p>
<p>In the current implementation, the IMU packets are sent every 1ms from hachidori and the PWM values are sent back every 5ms from PC at maximum.  The host PC becomes a Wi-Fi AP with hostapd and APM is running on the same linux PC.  This reduces latency a little bit.  The typical ping value in our tests is 2-3ms, though this easily increases to 5-50ms with a bit tough RF environments.</p>
<h2>failsafe on lost connection</h2>
<p>Even if the latency can be reduced somehow, another severe issue happens when the connection is lost or almost packets are lost. Currently, hachidori always computes its rough attitude by Madgwick filter. The frame tries to land with a simple attitude control when the connection is lost.</p>
<h2>prototype hardware</h2>
<p>Although I'm not a hardware expert, I've made some hardwares for proof of concept.</p>
<p><img src="../images/hachidori-coreless.jpg" alt="coreless" width=480></p>
<p>The prototypes have almost same simple hardwares:</p>
<ul>
<li>ESP-WROOM-32</li>
<li>MPU-9250</li>
<li>MS5611 or 2SMPB02(OMRON's new Baro)</li>
<li>INA226</li>
</ul>
<p>The board seen in the frame with coreless motors</p>
<p><img src="../images/bee3-board.png" alt="bee3 board" width=320></p>
<p>is a prototype and its firmware differs slightly from others.  The corresponding source of that firmware is the bee3-prototype branch of <a href="https://github.com/kazkojima/esp32-app/hachidori">esp32-app/hachidori</a> and here is its rough schematic</p>
<p><img src="../images/bee3-schematics.png" alt="bee3 schematic" width=480></p>
<p>I've tested that frame with ST's VL53L0X module as the range finder.  The master branch of that firmware source was planed for another board which wasn't completed.</p>
<p>I'm using MCPWM(Motor Control PWM) module of ESP32 for ESC and LEDC module for coreless motors. ESC is default on the master branch and isn't on bee3-prototype.</p>
<p>The primary purpose of hachidori is to be a tool in the development and education, with tiny indoor copters and rovers.  One can run waf/make easily on PC and test the new APM immediately.  It's similar with SITL in a sense, though I hope hachidori would give a fun with the real vehicles. I was almost new to the UAV world when starting this work. So I've experienced with many issues like damaged motors/propellers, vibration, ground effect, frame balance, battery problems, magnetic disturbance and so on with the real frame. Sounds great, doesn't it? :-)</p>
<p>Besides many problems, I think it has interesting possibilities. One might be possible to run APM with state of the art processors and try very heavy computational methods which won't work with the usual FC on the frames, ATM. I'm happy if you have some interests in this crazy and classical idea.</p>
<p>Happy Hacking,</p>
<p>kaz</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="../jbee3.html" rel="bookmark"
                           title="Permalink to hachidori - APM on PC with remote sensor/actuators">hachidori - APM on PC with remote sensor/actuators</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-12-01T00:00:00+09:00">
                Published: 金 01 12月 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/kaz-kojima.html">Kaz Kojima</a>
        </address>
<p>In <a href="../category/articles.html">articles</a>.</p>
<p>tags: <a href="../tag/ardupilot.html">ardupilot</a> <a href="../tag/esp32.html">esp32</a> <a href="../tag/kicad.html">KiCad</a> </p>
</footer><!-- /.post-info -->                <p><meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@1gkojima" />
<meta property="og:url" content="https://kazkojima.github.io/jbee3.html" />
<meta property="og:title" content="hachidori - APM on PC with remote sensor/actuators" />
<meta property="og:description" content="hachidori はPC上で走らせたArduPilotで制御する実験的なリモートセンサ/アクチュエータです." />
<meta property="og:image" content="https://kazkojima.github.io/images/bee3-flight.jpg" /></p>
<p><img src="../images/bee3-flight.jpg" alt="hachidori" width="640"></p>
<p>hachidori はPC上で走らせたArduPilotで制御する実験的なリモートセンサ/アクチュエータで, ArduPilotプロジェクトへの寄与を目的に始まった<a href="https://github.com/DCoJA">DCoJA</a>による小さなプロジェクトです.</p>
<p>私はDCoJAのメンバーであるドローンワークス社のコントラクターとしてArduPilotを同社が開発していたFCにポーティングする作業を行っていたのですがhachidoriはその中で派生したプロジェクトでした. 私とドローンワークス社とのコントラクトはすでに終了していますがオープンなプロジェクトとしてhachidoriの開発を続けています. プロジェクトの成果はDCoJAを通じてソフトウェアやプロトタイプの回路図などが<a href="https://github.com/DCoJA">オープンソースとして公開</a>されています.</p>
<p><img src="../images/hachidori-01.png" alt="scheme" width="640"></p>
<p>hachidoriからみるとArduPilotはセンサーデータを受け取りアクチュエータへの指示としてPWMの値を返すUDPサーバーです. このようなリモートセンサ/アクチュエータは実に古典的なアイデアですが,このスキームには大小様々な問題があります.</p>
<p>とりあえずトイドローンタイプのhachidoriの飛行はこんな感じです:</p>
<p><a href="https://drive.google.com/open?id=17t-W2Hi5uMc7od1iT-kai-gEbZudtBSQ"><img alt="test flight" src="../images/test-flight-toy.png" /></a></p>
<p>これはstabilizeモードです. APM(ArduPilot)はうまく姿勢を制御できているように見えます. arducopterはlaptop PCのUbuntu 4.4.0-lowlatencyカーネル上で動かしています.</p>
<p>250mmフレームにのせた別のhachidoriとAPMが動いているホストPCです:</p>
<p><img src="../images/hachidori-250-liftup.jpg" alt="250frame" width=320>
<img src="../images/hachidori-core-and-pc.jpg" alt="250 and PC" width=320></p>
<p>実験的なhachidori用ドライバを含んだArduPilotのソースツリー等は<a href="https://github.com/DCoJA">DCoJAのgithubリポジトリ</a>中のardupilotのhachidoriブランチにあります.</p>
<p>hachidoriのファームウェアは<a href="https://github.com/espressif/esp-idf">esp-idf</a>上の<a href="https://github.com/DCoJA/esp32-app/hachidori">application</a>になっています.
テストやコンフィグレーションのためのPC上の小さなUDPサーバーが<a href="https://github.com/DCoJA/junkyard">junkyard</a>の中にあります. b3testはセンサーデータの表示やモーターのテストのためのサーバー, b3confは設定や定数などをhachidoriに書きこむためのサーバーです.</p>
<h2>レイテンシ latency</h2>
<p>このようなスキームでの大きな問題の一つがレイテンシです. ご存知のように私達が普通に目にするほとんど全ての無線プロトコルはレイテンシに重点を置いていません. Wi-Fiを除けばそれらはいつも低消費電力が歌い文句ですしWi-Fiはスループット優先です. これらのプロトコルには再送という操作が存在することが多くこれがレイテンシの大きな原因となっています. 物理的データを再送するとリアルタイム性を失いあまり意味がない場合があります. ドローンのIMUから得られるデータが0.2秒遅れて送られて来た場合それは制御にどの程度役立つでしょうか? このケースでは再送などせずにさっさと次のデータを送って欲しいのですがそのようなプロトコルは一般的ではなく、またWi-FiやBTのようにある程度オープンなものはありません ...</p>
                <a class="readmore" href="../jbee3.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="../nrf24-shockburst.html" rel="bookmark"
                           title="Permalink to nRF24L01+ and ESP32">nRF24L01+ and ESP32</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-11-15T00:00:00+09:00">
                Published: 水 15 11月 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/kaz-kojima.html">Kaz Kojima</a>
        </address>
<p>In <a href="../category/articles.html">articles</a>.</p>
<p>tags: <a href="../tag/esp32.html">esp32</a> </p>
</footer><!-- /.post-info -->                <p>Nordic semiconductorのトランシーバーnRF24L01+をESP32にSPI接続して実験してみました</p>
<img alt="nrf24 spiclock to cs hold" src="../images/nrf24-test.jpg" style="width: 640px; height: 400px;" />
<p>対抗しているのはRaspiとnRF24L01+の組でそちらは</p>
<p><a class="reference external" href="http://tmrh20.github.io/RF24/">http://tmrh20.github.io/RF24/</a></p>
<p>にあるライブラリやプログラムを使いました.</p>
<p>このトランシーバーはBTやWiFiではなくShockburstという形式で通信します. コンフィグでACKを必要としないたれ流しができそうなのでレイテンシが減らせるか試そうと思っています.
リアルタイムのIMUデータとかなんども再送されてもあまりうれしくないしというのがもともとの動機です.</p>
<p>SPIでつなぐこと自体は簡単でGPIOの番号を</p>
<pre class="code c literal-block">
<span class="cp">#define PIN_NUM_MISO 19
#define PIN_NUM_MOSI 23
#define PIN_NUM_CLK  18
#define PIN_NUM_CS    5</span>
</pre>
<p>としています. SPI以外にnRF24L01+のRFトランシーバーをイネーブルするCEと割り込みの/INTを</p>
<pre class="code c literal-block">
<span class="cp">#define GPIO_NRF24_INT  GPIO_NUM_22
#define GPIO_NRF24_CE   GPIO_NUM_21</span>
</pre>
<p>につなぎました. SPIのコンフィグは</p>
<pre class="code c literal-block">
<span class="n">spi_bus_config_t</span> <span class="n">buscfg</span><span class="o">=</span><span class="p">{</span>
    <span class="p">.</span><span class="n">miso_io_num</span><span class="o">=</span><span class="n">PIN_NUM_MISO</span><span class="p">,</span>
    <span class="p">.</span><span class="n">mosi_io_num</span><span class="o">=</span><span class="n">PIN_NUM_MOSI</span><span class="p">,</span>
    <span class="p">.</span><span class="n">sclk_io_num</span><span class="o">=</span><span class="n">PIN_NUM_CLK</span><span class="p">,</span>
    <span class="p">.</span><span class="n">quadwp_io_num</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">.</span><span class="n">quadhd_io_num ...</span></pre>
                <a class="readmore" href="../nrf24-shockburst.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="../esp32-phy2.html" rel="bookmark"
                           title="Permalink to ESP32 PHY board 2">ESP32 PHY board 2</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-11-07T00:00:00+09:00">
                Published: 火 07 11月 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/kaz-kojima.html">Kaz Kojima</a>
        </address>
<p>In <a href="../category/english.html">English</a>.</p>
<p>tags: <a href="../tag/esp32.html">esp32</a> <a href="../tag/kicad.html">kicad</a> </p>
</footer><!-- /.post-info -->                <p>I'm trying another simple board for esp32 with ethernet. This is a board to mount ESP32 DevKit-C and Waveshare LAN8720 PHY module with a few extra parts. It can also use ESP-WROOM-32 chip directly instead of DevKit-C module.</p>
<img alt="esp32-wslan8720 test" src="../images/esp32ether2-test.jpg" style="width: 640px; height: 400px;" />
<img alt="esp32-wslan8720 board" src="../images/esp32ether2-board.jpg" style="width: 640px; height: 400px;" />
<p>KiCAD files for this board can be seen <a class="reference external" href="https://github.com/kazkojima/esp32-phy">here</a> as hardware ...</p>
                <a class="readmore" href="../esp32-phy2.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="../testing-espnow.html" rel="bookmark"
                           title="Permalink to Testing ESPNOW">Testing ESPNOW</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-10-28T00:00:00+09:00">
                Published: 土 28 10月 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/kaz-kojima.html">Kaz Kojima</a>
        </address>
<p>In <a href="../category/articles.html">articles</a>.</p>
<p>tags: <a href="../tag/esp32.html">esp32</a> </p>
</footer><!-- /.post-info -->                <p>ESP32の <a class="reference external" href="../esp32-phy.html">etherボード</a> とESP32の <a class="reference external" href="../images/bee3-board.png">センサボード</a>  でESPNOWでの通信を試して挙動を調べました.  全体の構成は</p>
<img alt="esp32 ether-espnow brigde" src="../images/ether-now-bridge.png" style="width: 640px; height: 400px;" />
<p>でPCの上ではarducopterとテスト用のUDPサーバの両方を動かして試してみました.</p>
<p><em>結果</em></p>
<p>現在のESP32のespnowは次のような挙動をするようです.</p>
<blockquote>
<ul class="simple">
<li>近接で通信した場合latencyは2ms位で安定している</li>
<li>送信と送信の間で間隔を空けることが必要で送信のみ繰り返す場合で~2msが必要に見える</li>
<li>受信を行うとこの間隔が影響される</li>
</ul>
</blockquote>
<p>実際のテストではセンサボードからespnowでパケットを投げ送信終了のコールバックが終わるまで待つようにしました. 送信のみの場合~500Hzぐらいのレートで~70byteぐらいのデータが送信できていました.</p>
<p>100Hzのレートで~30byteほどを受信するようにすると送信側のレートは10%以上低下しました. 送受の切り替え時にデッドタイムがあることを想像させるような挙動ですが、espnowのライブラリはソースがないので確かなことはわかりません.</p>
<p>このセンサボードからはIMUなどのパケットが1msに40byte程度でてくるのですが受信も行いながらだとパケットが最初に期待していたようなlatencyでは送り切れない状態が発生しています.
生のlatencyや処理コスト的にespnowは魅力的なのですが、リモートセンサ/アクチュエータ方式でコプターを飛ばすのは今の所少し厳しい感じです.</p>

                <a class="readmore" href="../testing-espnow.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="../esp32-2khz.html" rel="bookmark"
                           title="Permalink to ESP32 0.5ms tick">ESP32 0.5ms tick</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-10-22T00:00:00+09:00">
                Published: 日 22 10月 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/kaz-kojima.html">Kaz Kojima</a>
        </address>
<p>In <a href="../category/english.html">English</a>.</p>
<p>tags: <a href="../tag/esp32.html">esp32</a> <a href="../tag/freertos.html">freertos</a> </p>
</footer><!-- /.post-info -->                <p>You know that the maximal tick rate in ESP-IDF is 1000Hz.</p>
<img alt="esp-idf menuconfig 1000Hz" src="../images/config-1000Hz.png" style="width: 640px; height: 400px;" />
<p>This is ok for almost applications and if you require sub-milli time precision, the extra timer or interrupt would be your friend.
But why can't be 2000Hz tick rate set on 240Mz CPU?
Here is a famous LED ...</p>
                <a class="readmore" href="../esp32-2khz.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="../esp32-phy.html" rel="bookmark"
                           title="Permalink to ESP32 PHY board">ESP32 PHY board</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-10-18T00:00:00+09:00">
                Published: 水 18 10月 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/kaz-kojima.html">Kaz Kojima</a>
        </address>
<p>In <a href="../category/english.html">English</a>.</p>
<p>tags: <a href="../tag/esp32.html">esp32</a> <a href="../tag/kicad.html">kicad</a> </p>
</footer><!-- /.post-info -->                <p>I'm making a simple esp32 board with ethernet. ESP32 has MAC and esp-idf supports PHYs like LAN87x0 and TLK110 already. Here is the schematic with KiCAD:</p>
<img alt="esp32-tlk110 schematic" src="../images/esp32-tlk110.png" style="width: 640px; height: 400px;" />
<p>I'll create a git repository for that hardware if it works.</p>
<p><em>Update 2017-10-21</em></p>
<p>Now it works!</p>
<img alt="esp32-tlk110 works" src="../images/esp32-tlk110-jumpers.jpg" style="width: 640px; height: 400px;" />
<p>Revised KiCAD files for this board ...</p>
                <a class="readmore" href="../esp32-phy.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="../esp32-deep-sleep.html" rel="bookmark"
                           title="Permalink to ESP32 GPIO output in deep sleep mode">ESP32 GPIO output in deep sleep mode</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-07-28T00:00:00+09:00">
                Published: 金 28 7月 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/kaz-kojima.html">Kaz Kojima</a>
        </address>
<p>In <a href="../category/articles.html">articles</a>.</p>
<p>tags: <a href="../tag/esp32.html">esp32</a> </p>
</footer><!-- /.post-info -->                <p>ESP32のGPIOをOUTPUT modeにしてバッファSN74LVC3G07を使ってRGBのLEDを点灯させていたのですがdeep sleep modeにしたときに全点灯してしまうことに気がつきました. まあこのシステムだとESP32が止まっても他に電力を食うものがあるので光ること自体はあまり問題ではないんですがちょっと格好悪いです.</p>
<p>最初はdeep sleep modeに入る前に消しておいたらと思ったのですがdeep sleepするとGPIOがlowレベルになって全点灯してしまいました.  いろいろやるうちに逃げ道を見つけることができました.
いつまでこれでうまくいくかはわからないのですが.</p>
<p>話は簡単で</p>
<blockquote>
<ul class="simple">
<li>GPIOのコンフィグでのpull-up/downはdeep sleep時でも有効</li>
</ul>
</blockquote>
<p>なことを利用します. 問題のシステムでpull-upを立てておくとdeep sleep時にそれが効いてレベルがhighになって全消灯できました. こんな感じです (このシステムではRGBLED_OFF=1)</p>
<pre class="code c literal-block">
<span class="n">gpio_config_t</span> <span class="n">io_conf</span><span class="p">;</span>
<span class="n">io_conf</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">GPIO_PIN_INTR_DISABLE</span><span class="p">;</span>
<span class="n">io_conf</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_OUTPUT</span><span class="p">;</span>
<span class="n">io_conf</span><span class="p">.</span><span class="n">pin_bit_mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">GPIO_LED_RED</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">GPIO_LED_GREEN</span><span class="p">)</span>
                        <span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">GPIO_LED_BLUE</span><span class="p">));</span>
<span class="n">io_conf</span><span class="p">.</span><span class="n">pull_down_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// This ensures that all leds are off in deep sleep ...</span></pre>
                <a class="readmore" href="../esp32-deep-sleep.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="../esp32-spi.html" rel="bookmark"
                           title="Permalink to ESP32 SPI master issue">ESP32 SPI master issue</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-06-26T00:00:00+09:00">
                Published: 月 26 6月 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/kaz-kojima.html">Kaz Kojima</a>
        </address>
<p>In <a href="../category/articles.html">articles</a>.</p>
<p>tags: <a href="../tag/esp32.html">esp32</a> </p>
</footer><!-- /.post-info -->                <div class="figure align-left">
<img alt="esp-wroom-32 board" src="../images/bee3-board.png" style="width: 600.0px; height: 337.5px;" />
</div>
<p>My ESP-WROOM-32 board has 2 spi slave devices MPU-9250 and MS5611. I've troubled with DMA on spi. It looks <a class="reference external" href="https://github.com/espressif/esp-idf/issues/598">issue 598</a> which happens when DMA is used with the half-duplex mode and the command/address phases are disabled.
With enabling command phase, the problem went away.</p>
<pre class="code c literal-block">
<span class="err">&#64;&#64;</span> <span class="o">-</span><span class="mi">105</span><span class="p">,</span><span class="mi">12</span> <span class="o">+</span><span class="mi">105 ...</span></pre>
                <a class="readmore" href="../esp32-spi.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="http://www.fsij.org/">FSIJ</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/1gkojima">twitter</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>